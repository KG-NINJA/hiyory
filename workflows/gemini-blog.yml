# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“ã«ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ã‚’ä»˜ä¸
permissions:
  contents: write

name: Daily Funwari Forecast Blog # åå‰ã‚’ã€Œãµã‚“ã‚ã‚Šäºˆå ±ãƒ–ãƒ­ã‚°ã€ã«å¤‰æ›´

on:
  schedule:
    - cron: '0 2 * * *'  # æ—¥æœ¬æ™‚é–“11:00ï¼ˆUTCã§æŒ‡å®šï¼‰ã«å®Ÿè¡Œ
  workflow_dispatch:     # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹

jobs:
  generate-forecast: # ã‚¸ãƒ§ãƒ–åã‚’å¤‰æ›´ (generate-quote ã‹ã‚‰ generate-forecast ã¸)
    runs-on: ubuntu-latest

    env:
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ğŸ›  Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm install axios rss-parser # rss-parser ã‚’è¿½åŠ 

      - name: âœ¨ Gemini APIã§ãµã‚“ã‚ã‚Šäºˆå ±ã‚’ç”Ÿæˆã—Markdownã«ä¿å­˜
        run: |
          node .github/scripts/generate-quote.js # ã‚¹ã‚¯ãƒªãƒ—ãƒˆåã¯å¤‰æ›´ã—ãªã„å‰æ

      - name: âœ… Gitã¸ã‚³ãƒŸãƒƒãƒˆï¼†ãƒ—ãƒƒã‚·ãƒ¥
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          # generate-quote.js ãŒ _posts/YYYY-MM-DD-funwari-forecast.md ã¨ã„ã†åå‰ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹å ´åˆ
          git add _posts/*-funwari-forecast.md
          # å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥ã‚’å®Ÿè¡Œ
          if ! git diff --cached --quiet; then
            echo "å¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚"
            # ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã€Œãµã‚“ã‚ã‚Šäºˆå ±ã€ç”¨ã«å¤‰æ›´
            git commit -m "ğŸ”® ä»Šæ—¥ã®ãµã‚“ã‚ã‚Šäºˆå ±ã‚’è‡ªå‹•æŠ•ç¨¿ (`date --iso-8601=seconds`)"
            git push
          else
            echo "å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚³ãƒŸãƒƒãƒˆã¨ãƒ—ãƒƒã‚·ãƒ¥ã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          fi